<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Google Sheets API Integration - Digital Twin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --sidebar-bg: #222428;
      --sidebar-active: #2d3748;
      --sidebar-text: #bfc3ce;
      --sidebar-title: #fff;
      --main-bg: #141517;
      --card-bg: #23262b;
      --card-border: #292c31;
      --card-title: #bfc3ce;
      --card-value: #49a6ff;
      --card-desc: #8fa0b2;
      --header-bg: #191b1f;
      --header-title: #61b0ff;
      --btn-bg: #2d3748;
      --btn-text: #fff;
      --btn-active: #49a6ff;
      --btn-success: #28a745;
      --btn-warning: #ffc107;
      --btn-danger: #dc3545;
      --divider: #363941;
      --scrollbar: #333;
      --accent: #6c5ecb;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: var(--main-bg);
      color: #fff;
      font-family: 'Segoe UI', 'Malgun Gothic', Arial, sans-serif;
    }
    
    body {
      height: 100vh;
      display: flex;
      flex-direction: column;
      min-width: 1200px;
      overflow-x: auto;
    }
    
    .header {
      width: 100%;
      height: 56px;
      background: var(--header-bg);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
      box-sizing: border-box;
      border-bottom: 1px solid var(--divider);
      z-index: 10;
    }
    
    .header-title {
      font-size: 1.4em;
      font-weight: 700;
      color: var(--header-title);
      letter-spacing: 1px;
      display: flex;
      align-items: center;
    }
    
    .header-title span {
      color: #49a6ff;
      margin-right: 8px;
      font-size: 1.2em;
      font-weight: 900;
    }
    
    .header-menu {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .header-btn {
      background: var(--btn-bg);
      color: var(--btn-text);
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 0.9em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .header-btn:hover {
      background: var(--btn-active);
    }
    
    .header-btn.active {
      background: var(--btn-success);
    }
    
    .main-container {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }
    
    .config-section {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid var(--card-border);
    }
    
    .section-title {
      font-size: 1.3em;
      font-weight: 700;
      color: #fff;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      font-weight: 600;
      color: var(--sidebar-text);
      margin-bottom: 6px;
    }
    
    .form-input {
      width: 100%;
      background: var(--main-bg);
      color: var(--sidebar-text);
      border: 1px solid var(--card-border);
      border-radius: 6px;
      padding: 10px 12px;
      font-size: 0.95em;
      outline: none;
      transition: border-color 0.2s;
    }
    
    .form-input:focus {
      border-color: var(--btn-active);
    }
    
    .form-textarea {
      min-height: 100px;
      resize: vertical;
      font-family: 'Courier New', monospace;
    }
    
    .btn {
      background: var(--btn-active);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-right: 8px;
    }
    
    .btn:hover {
      background: #3d8bfd;
    }
    
    .btn.success {
      background: var(--btn-success);
    }
    
    .btn.warning {
      background: var(--btn-warning);
      color: #000;
    }
    
    .btn.danger {
      background: var(--btn-danger);
    }
    
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-connected {
      background: var(--btn-success);
    }
    
    .status-disconnected {
      background: var(--btn-danger);
    }
    
    .status-warning {
      background: var(--btn-warning);
    }
    
    .data-table {
      width: 100%;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .data-table table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th {
      background: var(--sidebar-bg);
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #fff;
      border-bottom: 1px solid var(--card-border);
    }
    
    .data-table td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      color: var(--sidebar-text);
    }
    
    .data-table tr:hover {
      background: rgba(255,255,255,0.05);
    }
    
    .log-container {
      background: var(--main-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 16px;
      height: 200px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      color: var(--sidebar-text);
    }
    
    .log-entry {
      margin-bottom: 4px;
      padding: 2px 0;
    }
    
    .log-timestamp {
      color: #8fa0b2;
    }
    
    .log-level-info {
      color: #49a6ff;
    }
    
    .log-level-success {
      color: #28a745;
    }
    
    .log-level-error {
      color: #dc3545;
    }
    
    .log-level-warning {
      color: #ffc107;
    }
    
    .message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-weight: 500;
    }
    
    .message.success {
      background: rgba(40, 167, 69, 0.2);
      color: #28a745;
      border: 1px solid rgba(40, 167, 69, 0.4);
    }
    
    .message.error {
      background: rgba(220, 53, 69, 0.2);
      color: #dc3545;
      border: 1px solid rgba(220, 53, 69, 0.4);
    }
    
    .message.info {
      background: rgba(73, 166, 255, 0.2);
      color: #49a6ff;
      border: 1px solid rgba(73, 166, 255, 0.4);
    }
    
    .config-example {
      background: var(--main-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 16px;
      margin-top: 12px;
    }
    
    .config-example pre {
      margin: 0;
      color: var(--sidebar-text);
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      white-space: pre-wrap;
    }
    
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }
    
    @media (max-width: 1200px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-title">
      <span>ğŸ“Š</span> Google Sheets API Integration
    </div>
    <div class="header-menu">
      <button class="header-btn" onclick="window.location.href='/'">
        â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
      </button>
    </div>
  </div>

  <div class="main-container">
    <!-- API ì„¤ì • ì„¹ì…˜ -->
    <div class="config-section">
      <div class="section-title">
        ğŸ”‘ Google Sheets API ì„¤ì •
      </div>
      
      <div class="grid-2">
        <div>
          <div class="form-group">
            <label class="form-label">API í‚¤</label>
            <input type="password" class="form-input" id="api-key" placeholder="Google Sheets API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            <small style="color: #8fa0b2;">Google Cloud Consoleì—ì„œ ë°œê¸‰ë°›ì€ API í‚¤</small>
          </div>
          
          <div class="form-group">
            <label class="form-label">ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID</label>
            <input type="text" class="form-input" id="spreadsheet-id" placeholder="ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            <small style="color: #8fa0b2;">URLì—ì„œ /d/ ë‹¤ìŒì— ì˜¤ëŠ” ê¸´ ë¬¸ìì—´</small>
          </div>
          
          <div class="form-group">
            <label class="form-label">ì‹œíŠ¸ ì´ë¦„</label>
            <input type="text" class="form-input" id="sheet-name" value="ë°ì´í„°" placeholder="ì‹œíŠ¸ ì´ë¦„">
          </div>
          
          <div class="form-group">
            <button class="btn" onclick="testConnection()">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
            <button class="btn success" onclick="saveConfig()">ì„¤ì • ì €ì¥</button>
            <button class="btn warning" onclick="loadSampleData()">ìƒ˜í”Œ ë°ì´í„° ë¡œë“œ</button>
          </div>
        </div>
        
        <div>
          <div class="form-group">
            <label class="form-label">ì—°ê²° ìƒíƒœ</label>
            <div id="connection-status">
              <span class="status-indicator status-disconnected"></span>
              ì—°ê²°ë˜ì§€ ì•ŠìŒ
            </div>
          </div>
          
          <div class="config-example">
            <pre>ìŠ¤í”„ë ˆë“œì‹œíŠ¸ URL ì˜ˆì‹œ:
https://docs.google.com/spreadsheets/d/<strong>1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms</strong>/edit

ìœ„ URLì—ì„œ êµµê²Œ í‘œì‹œëœ ë¶€ë¶„ì´ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDì…ë‹ˆë‹¤.</pre>
          </div>
        </div>
      </div>
    </div>

    <!-- ë°ì´í„° ë§¤í•‘ ì„¤ì • -->
    <div class="config-section">
      <div class="section-title">
        ğŸ—‚ï¸ ë°ì´í„° ë§¤í•‘ ì„¤ì •
      </div>
      
      <div class="form-group">
        <label class="form-label">ì—´ ë§¤í•‘ (JSON í˜•ì‹)</label>
        <textarea class="form-input form-textarea" id="column-mapping">{
  "timestamp": "A",
  "temperature": "B", 
  "humidity": "C",
  "energy": "D",
  "door_events": "E",
  "illumination": "F"
}</textarea>
        <small style="color: #8fa0b2;">ê° ë°ì´í„° í•­ëª©ì´ ì €ì¥ë  ì—´ì„ ì§€ì •í•©ë‹ˆë‹¤</small>
      </div>
      
      <div class="form-group">
        <button class="btn" onclick="validateMapping()">ë§¤í•‘ ê²€ì¦</button>
        <button class="btn success" onclick="createHeaders()">í—¤ë” ìƒì„±</button>
      </div>
    </div>

    <!-- ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™” -->
    <div class="config-section">
      <div class="section-title">
        ğŸ”„ ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™”
      </div>
      
      <div class="grid-2">
        <div>
          <div class="form-group">
            <label class="form-label">ë™ê¸°í™” ê°„ê²© (ì´ˆ)</label>
            <input type="number" class="form-input" id="sync-interval" value="30" min="10" max="3600">
          </div>
          
          <div class="form-group">
            <label class="form-label">ë°°ì¹˜ í¬ê¸°</label>
            <input type="number" class="form-input" id="batch-size" value="10" min="1" max="100">
            <small style="color: #8fa0b2;">í•œ ë²ˆì— ì „ì†¡í•  ë°ì´í„° í–‰ ìˆ˜</small>
          </div>
          
          <div class="form-group">
            <button class="btn" id="sync-btn" onclick="toggleSync()">ë™ê¸°í™” ì‹œì‘</button>
            <button class="btn warning" onclick="clearQueue()">í ë¹„ìš°ê¸°</button>
            <button class="btn danger" onclick="clearAllData()">ëª¨ë“  ë°ì´í„° ì‚­ì œ</button>
          </div>
        </div>
        
        <div>
          <div class="form-group">
            <label class="form-label">ë™ê¸°í™” ìƒíƒœ</label>
            <div id="sync-status">
              <span class="status-indicator status-disconnected"></span>
              ì¤‘ì§€ë¨ (ëŒ€ê¸° ì¤‘: <span id="queue-count">0</span>ê°œ)
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">ë§ˆì§€ë§‰ ë™ê¸°í™”</label>
            <div id="last-sync">ì•„ì§ ë™ê¸°í™”ë˜ì§€ ì•ŠìŒ</div>
          </div>
          
          <div class="form-group">
            <label class="form-label">ë™ê¸°í™” í†µê³„</label>
            <div style="color: var(--sidebar-text); font-size: 0.9em;">
              ì„±ê³µ: <span id="sync-success">0</span> | 
              ì‹¤íŒ¨: <span id="sync-failed">0</span> | 
              ì´ í–‰: <span id="total-rows">0</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° -->
    <div class="config-section">
      <div class="section-title">
        ğŸ“‹ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°
      </div>
      
      <div class="form-group">
        <button class="btn" onclick="refreshPreview()">ìƒˆë¡œê³ ì¹¨</button>
        <button class="btn" onclick="exportData()">ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
        <button class="btn" onclick="addSampleRow()">ìƒ˜í”Œ í–‰ ì¶”ê°€</button>
      </div>
      
      <div id="data-preview" class="data-table">
        <table>
          <thead>
            <tr>
              <th>íƒ€ì„ìŠ¤íƒ¬í”„</th>
              <th>ì˜¨ë„ (Â°C)</th>
              <th>ìŠµë„ (%)</th>
              <th>ì—ë„ˆì§€ (kWh)</th>
              <th>ë¬¸ ì´ë²¤íŠ¸</th>
              <th>ì¡°ë„ (lux)</th>
            </tr>
          </thead>
          <tbody id="data-tbody">
            <tr>
              <td colspan="6" style="text-align: center; color: #8fa0b2;">
                ë°ì´í„°ë¥¼ ë¡œë“œí•˜ë ¤ë©´ 'ìƒˆë¡œê³ ì¹¨' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ë¡œê·¸ -->
    <div class="config-section">
      <div class="section-title">
        ğŸ“ ì‹œìŠ¤í…œ ë¡œê·¸
      </div>
      
      <div class="form-group">
        <button class="btn" onclick="clearLogs()">ë¡œê·¸ ì§€ìš°ê¸°</button>
        <button class="btn" onclick="exportLogs()">ë¡œê·¸ ë‚´ë³´ë‚´ê¸°</button>
      </div>
      
      <div id="logs" class="log-container">
        <div class="log-entry">
          <span class="log-timestamp">[2024-01-01 00:00:00]</span>
          <span class="log-level-info">[INFO]</span>
          ì‹œìŠ¤í…œì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.
        </div>
      </div>
    </div>
  </div>

  <!-- Google Sheets API ë¡œë“œ -->
  <script src="https://apis.google.com/js/api.js"></script>
  
  <script>
    // ì „ì—­ ë³€ìˆ˜
    let isApiLoaded = false;
    let isConnected = false;
    let syncInterval = null;
    let dataQueue = [];
    let syncStats = {
      success: 0,
      failed: 0,
      totalRows: 0
    };
    
    // API ì„¤ì •
    let apiConfig = {
      apiKey: '',
      spreadsheetId: '',
      sheetName: 'ë°ì´í„°',
      columnMapping: {
        timestamp: 'A',
        temperature: 'B',
        humidity: 'C',
        energy: 'D',
        door_events: 'E',
        illumination: 'F'
      }
    };
    
    // Google API ì´ˆê¸°í™”
    function initGoogleAPI() {
      return new Promise((resolve, reject) => {
        if (typeof gapi === 'undefined') {
          addLog('error', 'Google API ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          reject(new Error('Google API not loaded'));
          return;
        }
        
        gapi.load('client', () => {
          gapi.client.init({
            apiKey: apiConfig.apiKey,
            discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
          }).then(() => {
            isApiLoaded = true;
            addLog('success', 'Google Sheets APIê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            resolve();
          }).catch(error => {
            addLog('error', 'API ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message);
            reject(error);
          });
        });
      });
    }
    
    // ì—°ê²° í…ŒìŠ¤íŠ¸
    async function testConnection() {
      try {
        loadConfig();
        
        if (!apiConfig.apiKey || !apiConfig.spreadsheetId) {
          throw new Error('API í‚¤ì™€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        }
        
        addLog('info', 'ì—°ê²° í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...');
        
        if (!isApiLoaded) {
          await initGoogleAPI();
        }
        
        // ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë©”íƒ€ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const response = await gapi.client.sheets.spreadsheets.get({
          spreadsheetId: apiConfig.spreadsheetId
        });
        
        if (response.status === 200) {
          isConnected = true;
          updateConnectionStatus(true);
          addLog('success', `ì—°ê²° ì„±ê³µ: ${response.result.properties.title}`);
          
          // ì‹œíŠ¸ ì¡´ì¬ í™•ì¸
          const sheets = response.result.sheets;
          const targetSheet = sheets.find(sheet => sheet.properties.title === apiConfig.sheetName);
          
          if (targetSheet) {
            addLog('success', `ëŒ€ìƒ ì‹œíŠ¸ '${apiConfig.sheetName}' í™•ì¸ë¨`);
          } else {
            addLog('warning', `ì‹œíŠ¸ '${apiConfig.sheetName}'ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œíŠ¸: ${sheets.map(s => s.properties.title).join(', ')}`);
          }
          
        } else {
          throw new Error('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
        
      } catch (error) {
        isConnected = false;
        updateConnectionStatus(false);
        addLog('error', 'ì—°ê²° ì‹¤íŒ¨: ' + error.message);
        
        if (error.message.includes('403')) {
          addLog('error', 'API í‚¤ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”. Google Sheets APIê°€ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
        } else if (error.message.includes('404')) {
          addLog('error', 'ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. IDë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
        }
      }
    }
    
    // ì„¤ì • ì €ì¥
    function saveConfig() {
      try {
        loadConfig();
        localStorage.setItem('googleSheetsConfig', JSON.stringify(apiConfig));
        addLog('success', 'ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (error) {
        addLog('error', 'ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ' + error.message);
      }
    }
    
    // ì„¤ì • ë¡œë“œ
    function loadConfig() {
      try {
        apiConfig.apiKey = document.getElementById('api-key').value;
        apiConfig.spreadsheetId = document.getElementById('spreadsheet-id').value;
        apiConfig.sheetName = document.getElementById('sheet-name').value;
        
        const mappingText = document.getElementById('column-mapping').value;
        apiConfig.columnMapping = JSON.parse(mappingText);
        
        // ì €ì¥ëœ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        const saved = localStorage.getItem('googleSheetsConfig');
        if (saved) {
          const savedConfig = JSON.parse(saved);
          if (!apiConfig.apiKey) {
            document.getElementById('api-key').value = savedConfig.apiKey || '';
            apiConfig.apiKey = savedConfig.apiKey || '';
          }
          if (!apiConfig.spreadsheetId) {
            document.getElementById('spreadsheet-id').value = savedConfig.spreadsheetId || '';
            apiConfig.spreadsheetId = savedConfig.spreadsheetId || '';
          }
        }
        
      } catch (error) {
        addLog('error', 'ì„¤ì • ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
      }
    }
    
    // ë§¤í•‘ ê²€ì¦
    function validateMapping() {
      try {
        const mappingText = document.getElementById('column-mapping').value;
        const mapping = JSON.parse(mappingText);
        
        const requiredFields = ['timestamp', 'temperature', 'humidity', 'energy', 'door_events', 'illumination'];
        const missingFields = requiredFields.filter(field => !mapping[field]);
        
        if (missingFields.length > 0) {
          throw new Error(`í•„ìˆ˜ í•„ë“œê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤: ${missingFields.join(', ')}`);
        }
        
        addLog('success', 'ë§¤í•‘ ê²€ì¦ ì™„ë£Œ. ëª¨ë“  í•„ë“œê°€ ì˜¬ë°”ë¥´ê²Œ ë§¤í•‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (error) {
        addLog('error', 'ë§¤í•‘ ê²€ì¦ ì‹¤íŒ¨: ' + error.message);
      }
    }
    
    // í—¤ë” ìƒì„±
    async function createHeaders() {
      try {
        if (!isConnected) {
          throw new Error('ë¨¼ì € Google Sheetsì— ì—°ê²°í•´ì£¼ì„¸ìš”.');
        }
        
        loadConfig();
        
        const headers = [
          ['íƒ€ì„ìŠ¤íƒ¬í”„', 'ì˜¨ë„(Â°C)', 'ìŠµë„(%)', 'ì—ë„ˆì§€(kWh)', 'ë¬¸ ì´ë²¤íŠ¸', 'ì¡°ë„(lux)']
        ];
        
        const range = `${apiConfig.sheetName}!A1:F1`;
        
        const response = await gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId: apiConfig.spreadsheetId,
          range: range,
          valueInputOption: 'RAW',
          resource: {
            values: headers
          }
        });
        
        if (response.status === 200) {
          addLog('success', 'í—¤ë”ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        
      } catch (error) {
        addLog('error', 'í—¤ë” ìƒì„± ì‹¤íŒ¨: ' + error.message);
      }
    }
    
    // ìƒ˜í”Œ ë°ì´í„° ë¡œë“œ
    function loadSampleData() {
      const sampleData = [];
      const now = new Date();
      
      for (let i = 0; i < 10; i++) {
        const timestamp = new Date(now.getTime() - (i * 60 * 60 * 1000));
        sampleData.push({
          timestamp: timestamp.toISOString(),
          temperature: (20 + Math.random() * 10).toFixed(1),
          humidity: Math.floor(40 + Math.random() * 30),
          energy: (100 + Math.random() * 50).toFixed(1),
          door_events: Math.floor(Math.random() * 5),
          illumination: Math.floor(200 + Math.random() * 300)
        });
      }
      
      dataQueue.push(...sampleData);
      updateQueueStatus();
      addLog('info', `${sampleData.length}ê°œì˜ ìƒ˜í”Œ ë°ì´í„°ê°€ íì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }
    
    // ë™ê¸°í™” í† ê¸€
    function toggleSync() {
      if (syncInterval) {
        stopSync();
      } else {
        startSync();
      }
    }
    
    // ë™ê¸°í™” ì‹œì‘
    function startSync() {
      if (!isConnected) {
        addLog('error', 'ë¨¼ì € Google Sheetsì— ì—°ê²°í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const interval = parseInt(document.getElementById('sync-interval').value) * 1000;
      
      syncInterval = setInterval(syncData, interval);
      document.getElementById('sync-btn').textContent = 'ë™ê¸°í™” ì¤‘ì§€';
      document.getElementById('sync-btn').className = 'btn danger';
      
      updateSyncStatus(true);
      addLog('success', `ë™ê¸°í™”ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. (ê°„ê²©: ${interval/1000}ì´ˆ)`);
    }
    
    // ë™ê¸°í™” ì¤‘ì§€
    function stopSync() {
      if (syncInterval) {
        clearInterval(syncInterval);
        syncInterval = null;
      }
      
      document.getElementById('sync-btn').textContent = 'ë™ê¸°í™” ì‹œì‘';
      document.getElementById('sync-btn').className = 'btn';
      
      updateSyncStatus(false);
      addLog('info', 'ë™ê¸°í™”ê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    
    // ë°ì´í„° ë™ê¸°í™”
    async function syncData() {
      if (dataQueue.length === 0) {
        return;
      }
      
      try {
        const batchSize = parseInt(document.getElementById('batch-size').value);
        const batch = dataQueue.splice(0, batchSize);
        
        const values = batch.map(item => [
          item.timestamp,
          item.temperature,
          item.humidity,
          item.energy,
          item.door_events,
          item.illumination
        ]);
        
        // ë‹¤ìŒ ë¹ˆ í–‰ ì°¾ê¸°
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: apiConfig.spreadsheetId,
          range: `${apiConfig.sheetName}!A:A`
        });
        
        const nextRow = (response.result.values?.length || 0) + 1;
        const range = `${apiConfig.sheetName}!A${nextRow}:F${nextRow + values.length - 1}`;
        
        await gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId: apiConfig.spreadsheetId,
          range: range,
          valueInputOption: 'RAW',
          resource: { values: values }
        });
        
        syncStats.success += batch.length;
        syncStats.totalRows += batch.length;
        updateSyncStats();
        updateQueueStatus();
        
        document.getElementById('last-sync').textContent = new Date().toLocaleString('ko-KR');
        addLog('success', `${batch.length}ê°œ í–‰ì´ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        
      } catch (error) {
        syncStats.failed += 1;
        updateSyncStats();
        addLog('error', 'ë™ê¸°í™” ì‹¤íŒ¨: ' + error.message);
      }
    }
    
    // ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° ìƒˆë¡œê³ ì¹¨
    async function refreshPreview() {
      try {
        if (!isConnected) {
          throw new Error('ë¨¼ì € Google Sheetsì— ì—°ê²°í•´ì£¼ì„¸ìš”.');
        }
        
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: apiConfig.spreadsheetId,
          range: `${apiConfig.sheetName}!A2:F21`  // ìµœê·¼ 20í–‰
        });
        
        const tbody = document.getElementById('data-tbody');
        tbody.innerHTML = '';
        
        if (response.result.values && response.result.values.length > 0) {
          response.result.values.reverse().forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${row[0] || ''}</td>
              <td>${row[1] || ''}</td>
              <td>${row[2] || ''}</td>
              <td>${row[3] || ''}</td>
              <td>${row[4] || ''}</td>
              <td>${row[5] || ''}</td>
            `;
            tbody.appendChild(tr);
          });
        } else {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #8fa0b2;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        }
        
        addLog('success', 'ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°ê°€ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
        
      } catch (error) {
        addLog('error', 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
      }
    }
    
    // ìƒ˜í”Œ í–‰ ì¶”ê°€
    function addSampleRow() {
      const now = new Date();
      const sampleRow = {
        timestamp: now.toISOString(),
        temperature: (20 + Math.random() * 10).toFixed(1),
        humidity: Math.floor(40 + Math.random() * 30),
        energy: (100 + Math.random() * 50).toFixed(1),
        door_events: Math.floor(Math.random() * 3),
        illumination: Math.floor(200 + Math.random() * 300)
      };
      
      dataQueue.push(sampleRow);
      updateQueueStatus();
      addLog('info', 'ìƒ˜í”Œ í–‰ì´ íì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    
    // í ë¹„ìš°ê¸°
    function clearQueue() {
      dataQueue = [];
      updateQueueStatus();
      addLog('info', 'ë°ì´í„° íê°€ ë¹„ì›Œì¡ŒìŠµë‹ˆë‹¤.');
    }
    
    // ëª¨ë“  ë°ì´í„° ì‚­ì œ
    async function clearAllData() {
      if (!confirm('ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
      }
      
      try {
        if (!isConnected) {
          throw new Error('ë¨¼ì € Google Sheetsì— ì—°ê²°í•´ì£¼ì„¸ìš”.');
        }
        
        // í—¤ë” ì œì™¸í•œ ëª¨ë“  ë°ì´í„° ì‚­ì œ
        await gapi.client.sheets.spreadsheets.values.clear({
          spreadsheetId: apiConfig.spreadsheetId,
          range: `${apiConfig.sheetName}!A2:F`
        });
        
        syncStats = { success: 0, failed: 0, totalRows: 0 };
        updateSyncStats();
        refreshPreview();
        
        addLog('warning', 'ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        
      } catch (error) {
        addLog('error', 'ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
      }
    }
    
    // ë°ì´í„° ë‚´ë³´ë‚´ê¸°
    async function exportData() {
      try {
        if (!isConnected) {
          throw new Error('ë¨¼ì € Google Sheetsì— ì—°ê²°í•´ì£¼ì„¸ìš”.');
        }
        
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: apiConfig.spreadsheetId,
          range: `${apiConfig.sheetName}!A1:F`
        });
        
        if (response.result.values) {
          const csv = response.result.values.map(row => row.join(',')).join('\n');
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          link.setAttribute('download', `digital_twin_data_${new Date().toISOString().split('T')[0]}.csv`);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          addLog('success', 'CSV íŒŒì¼ë¡œ ë‚´ë³´ë‚´ê¸° ì™„ë£Œ');
        }
        
      } catch (error) {
        addLog('error', 'ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ' + error.message);
      }
    }
    
    // ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤
    function updateConnectionStatus(connected) {
      const status = document.getElementById('connection-status');
      if (connected) {
        status.innerHTML = '<span class="status-indicator status-connected"></span>ì—°ê²°ë¨';
      } else {
        status.innerHTML = '<span class="status-indicator status-disconnected"></span>ì—°ê²°ë˜ì§€ ì•ŠìŒ';
      }
    }
    
    function updateSyncStatus(syncing) {
      const status = document.getElementById('sync-status');
      if (syncing) {
        status.innerHTML = `<span class="status-indicator status-connected"></span>ë™ê¸°í™” ì¤‘ (ëŒ€ê¸° ì¤‘: <span id="queue-count">${dataQueue.length}</span>ê°œ)`;
      } else {
        status.innerHTML = `<span class="status-indicator status-disconnected"></span>ì¤‘ì§€ë¨ (ëŒ€ê¸° ì¤‘: <span id="queue-count">${dataQueue.length}</span>ê°œ)`;
      }
    }
    
    function updateQueueStatus() {
      const queueCount = document.getElementById('queue-count');
      if (queueCount) {
        queueCount.textContent = dataQueue.length;
      }
    }
    
    function updateSyncStats() {
      document.getElementById('sync-success').textContent = syncStats.success;
      document.getElementById('sync-failed').textContent = syncStats.failed;
      document.getElementById('total-rows').textContent = syncStats.totalRows;
    }
    
    // ë¡œê·¸ ê´€ë ¨ í•¨ìˆ˜ë“¤
    function addLog(level, message) {
      const logs = document.getElementById('logs');
      const logEntry = document.createElement('div');
      logEntry.className = 'log-entry';
      
      const timestamp = new Date().toLocaleString('ko-KR');
      logEntry.innerHTML = `
        <span class="log-timestamp">[${timestamp}]</span>
        <span class="log-level-${level}">[${level.toUpperCase()}]</span>
        ${message}
      `;
      
      logs.insertBefore(logEntry, logs.firstChild);
      
      // ë¡œê·¸ê°€ ë„ˆë¬´ ë§ìœ¼ë©´ ì˜¤ë˜ëœ ê²ƒë¶€í„° ì‚­ì œ
      if (logs.children.length > 100) {
        logs.removeChild(logs.lastChild);
      }
      
      // ë¡œê·¸ ì»¨í…Œì´ë„ˆë¥¼ ë§¨ ìœ„ë¡œ ìŠ¤í¬ë¡¤
      logs.scrollTop = 0;
    }
    
    function clearLogs() {
      document.getElementById('logs').innerHTML = '';
      addLog('info', 'ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.');
    }
    
    function exportLogs() {
      const logs = document.getElementById('logs');
      const logText = Array.from(logs.children).map(entry => entry.textContent).join('\n');
      
      const blob = new Blob([logText], { type: 'text/plain;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `digital_twin_logs_${new Date().toISOString().split('T')[0]}.txt`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      addLog('success', 'ë¡œê·¸ê°€ í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤.');
    }
    
    // ì™¸ë¶€ì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” í•¨ìˆ˜ë“¤ (ë©”ì¸ ëŒ€ì‹œë³´ë“œì—ì„œ ì‚¬ìš©)
    window.GoogleSheetsAPI = {
      addData: function(data) {
        dataQueue.push(data);
        updateQueueStatus();
      },
      
      isConnected: function() {
        return isConnected;
      },
      
      getStats: function() {
        return syncStats;
      }
    };
    
    // ì´ˆê¸°í™”
    window.addEventListener('load', () => {
      loadConfig();
      updateQueueStatus();
      addLog('info', 'Google Sheets API í†µí•© í˜ì´ì§€ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
      
      // ìë™ìœ¼ë¡œ ì €ì¥ëœ ì„¤ì •ì´ ìˆìœ¼ë©´ ì—°ê²° í…ŒìŠ¤íŠ¸
      if (apiConfig.apiKey && apiConfig.spreadsheetId) {
        setTimeout(testConnection, 1000);
      }
    });
  </script>
</body>
</html>