<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Google Sheets API Integration - Digital Twin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --sidebar-bg: #222428;
      --sidebar-active: #2d3748;
      --sidebar-text: #bfc3ce;
      --sidebar-title: #fff;
      --main-bg: #141517;
      --card-bg: #23262b;
      --card-border: #292c31;
      --card-title: #bfc3ce;
      --card-value: #49a6ff;
      --card-desc: #8fa0b2;
      --header-bg: #191b1f;
      --header-title: #61b0ff;
      --btn-bg: #2d3748;
      --btn-text: #fff;
      --btn-active: #49a6ff;
      --btn-success: #28a745;
      --btn-warning: #ffc107;
      --btn-danger: #dc3545;
      --divider: #363941;
      --scrollbar: #333;
      --accent: #6c5ecb;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: var(--main-bg);
      color: #fff;
      font-family: 'Segoe UI', 'Malgun Gothic', Arial, sans-serif;
    }
    
    body {
      height: 100vh;
      display: flex;
      flex-direction: column;
      min-width: 1200px;
      overflow-x: auto;
    }
    
    .header {
      width: 100%;
      height: 56px;
      background: var(--header-bg);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
      box-sizing: border-box;
      border-bottom: 1px solid var(--divider);
      z-index: 10;
    }
    
    .header-title {
      font-size: 1.4em;
      font-weight: 700;
      color: var(--header-title);
      letter-spacing: 1px;
      display: flex;
      align-items: center;
    }
    
    .header-title span {
      color: #49a6ff;
      margin-right: 8px;
      font-size: 1.2em;
      font-weight: 900;
    }
    
    .header-menu {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .header-btn {
      background: var(--btn-bg);
      color: var(--btn-text);
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 0.9em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .header-btn:hover {
      background: var(--btn-active);
    }
    
    .header-btn.active {
      background: var(--btn-success);
    }
    
    .main-container {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }
    
    .config-section {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid var(--card-border);
    }
    
    .section-title {
      font-size: 1.3em;
      font-weight: 700;
      color: #fff;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      font-weight: 600;
      color: var(--sidebar-text);
      margin-bottom: 6px;
    }
    
    .form-input {
      width: 100%;
      background: var(--main-bg);
      color: var(--sidebar-text);
      border: 1px solid var(--card-border);
      border-radius: 6px;
      padding: 10px 12px;
      font-size: 0.95em;
      outline: none;
      transition: border-color 0.2s;
    }
    
    .form-input:focus {
      border-color: var(--btn-active);
    }
    
    .form-textarea {
      min-height: 100px;
      resize: vertical;
      font-family: 'Courier New', monospace;
    }
    
    .btn {
      background: var(--btn-active);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-right: 8px;
    }
    
    .btn:hover {
      background: #3d8bfd;
    }
    
    .btn.success {
      background: var(--btn-success);
    }
    
    .btn.warning {
      background: var(--btn-warning);
      color: #000;
    }
    
    .btn.danger {
      background: var(--btn-danger);
    }
    
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-connected {
      background: var(--btn-success);
    }
    
    .status-disconnected {
      background: var(--btn-danger);
    }
    
    .status-warning {
      background: var(--btn-warning);
    }
    
    .data-table {
      width: 100%;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .data-table table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th {
      background: var(--sidebar-bg);
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #fff;
      border-bottom: 1px solid var(--card-border);
    }
    
    .data-table td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      color: var(--sidebar-text);
    }
    
    .data-table tr:hover {
      background: rgba(255,255,255,0.05);
    }
    
    .log-container {
      background: var(--main-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 16px;
      height: 200px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      color: var(--sidebar-text);
    }
    
    .log-entry {
      margin-bottom: 4px;
      padding: 2px 0;
    }
    
    .log-timestamp {
      color: #8fa0b2;
    }
    
    .log-level-info {
      color: #49a6ff;
    }
    
    .log-level-success {
      color: #28a745;
    }
    
    .log-level-error {
      color: #dc3545;
    }
    
    .log-level-warning {
      color: #ffc107;
    }
    
    .message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-weight: 500;
    }
    
    .message.success {
      background: rgba(40, 167, 69, 0.2);
      color: #28a745;
      border: 1px solid rgba(40, 167, 69, 0.4);
    }
    
    .message.error {
      background: rgba(220, 53, 69, 0.2);
      color: #dc3545;
      border: 1px solid rgba(220, 53, 69, 0.4);
    }
    
    .message.info {
      background: rgba(73, 166, 255, 0.2);
      color: #49a6ff;
      border: 1px solid rgba(73, 166, 255, 0.4);
    }
    
    .config-example {
      background: var(--main-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 16px;
      margin-top: 12px;
    }
    
    .config-example pre {
      margin: 0;
      color: var(--sidebar-text);
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      white-space: pre-wrap;
    }
    
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }
    
    @media (max-width: 1200px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-title">
      <span>📊</span> Google Sheets API Integration
    </div>
    <div class="header-menu">
      <button class="header-btn" onclick="window.location.href='/'">
        ← 대시보드로 돌아가기
      </button>
    </div>
  </div>

  <div class="main-container">
    <!-- API 설정 섹션 -->
    <div class="config-section">
      <div class="section-title">
        🔑 Google Sheets API 설정
      </div>
      
      <div class="grid-2">
        <div>
          <div class="form-group">
            <label class="form-label">API 키</label>
            <input type="password" class="form-input" id="api-key" placeholder="Google Sheets API 키를 입력하세요">
            <small style="color: #8fa0b2;">Google Cloud Console에서 발급받은 API 키</small>
          </div>
          
          <div class="form-group">
            <label class="form-label">스프레드시트 ID</label>
            <input type="text" class="form-input" id="spreadsheet-id" placeholder="스프레드시트 ID를 입력하세요">
            <small style="color: #8fa0b2;">URL에서 /d/ 다음에 오는 긴 문자열</small>
          </div>
          
          <div class="form-group">
            <label class="form-label">시트 이름</label>
            <input type="text" class="form-input" id="sheet-name" value="데이터" placeholder="시트 이름">
          </div>
          
          <div class="form-group">
            <button class="btn" onclick="testConnection()">연결 테스트</button>
            <button class="btn success" onclick="saveConfig()">설정 저장</button>
            <button class="btn warning" onclick="loadSampleData()">샘플 데이터 로드</button>
          </div>
        </div>
        
        <div>
          <div class="form-group">
            <label class="form-label">연결 상태</label>
            <div id="connection-status">
              <span class="status-indicator status-disconnected"></span>
              연결되지 않음
            </div>
          </div>
          
          <div class="config-example">
            <pre>스프레드시트 URL 예시:
https://docs.google.com/spreadsheets/d/<strong>1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms</strong>/edit

위 URL에서 굵게 표시된 부분이 스프레드시트 ID입니다.</pre>
          </div>
        </div>
      </div>
    </div>

    <!-- 데이터 매핑 설정 -->
    <div class="config-section">
      <div class="section-title">
        🗂️ 데이터 매핑 설정
      </div>
      
      <div class="form-group">
        <label class="form-label">열 매핑 (JSON 형식)</label>
        <textarea class="form-input form-textarea" id="column-mapping">{
  "timestamp": "A",
  "temperature": "B", 
  "humidity": "C",
  "energy": "D",
  "door_events": "E",
  "illumination": "F"
}</textarea>
        <small style="color: #8fa0b2;">각 데이터 항목이 저장될 열을 지정합니다</small>
      </div>
      
      <div class="form-group">
        <button class="btn" onclick="validateMapping()">매핑 검증</button>
        <button class="btn success" onclick="createHeaders()">헤더 생성</button>
      </div>
    </div>

    <!-- 실시간 데이터 동기화 -->
    <div class="config-section">
      <div class="section-title">
        🔄 실시간 데이터 동기화
      </div>
      
      <div class="grid-2">
        <div>
          <div class="form-group">
            <label class="form-label">동기화 간격 (초)</label>
            <input type="number" class="form-input" id="sync-interval" value="30" min="10" max="3600">
          </div>
          
          <div class="form-group">
            <label class="form-label">배치 크기</label>
            <input type="number" class="form-input" id="batch-size" value="10" min="1" max="100">
            <small style="color: #8fa0b2;">한 번에 전송할 데이터 행 수</small>
          </div>
          
          <div class="form-group">
            <button class="btn" id="sync-btn" onclick="toggleSync()">동기화 시작</button>
            <button class="btn warning" onclick="clearQueue()">큐 비우기</button>
            <button class="btn danger" onclick="clearAllData()">모든 데이터 삭제</button>
          </div>
        </div>
        
        <div>
          <div class="form-group">
            <label class="form-label">동기화 상태</label>
            <div id="sync-status">
              <span class="status-indicator status-disconnected"></span>
              중지됨 (대기 중: <span id="queue-count">0</span>개)
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">마지막 동기화</label>
            <div id="last-sync">아직 동기화되지 않음</div>
          </div>
          
          <div class="form-group">
            <label class="form-label">동기화 통계</label>
            <div style="color: var(--sidebar-text); font-size: 0.9em;">
              성공: <span id="sync-success">0</span> | 
              실패: <span id="sync-failed">0</span> | 
              총 행: <span id="total-rows">0</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 데이터 미리보기 -->
    <div class="config-section">
      <div class="section-title">
        📋 데이터 미리보기
      </div>
      
      <div class="form-group">
        <button class="btn" onclick="refreshPreview()">새로고침</button>
        <button class="btn" onclick="exportData()">데이터 내보내기</button>
        <button class="btn" onclick="addSampleRow()">샘플 행 추가</button>
      </div>
      
      <div id="data-preview" class="data-table">
        <table>
          <thead>
            <tr>
              <th>타임스탬프</th>
              <th>온도 (°C)</th>
              <th>습도 (%)</th>
              <th>에너지 (kWh)</th>
              <th>문 이벤트</th>
              <th>조도 (lux)</th>
            </tr>
          </thead>
          <tbody id="data-tbody">
            <tr>
              <td colspan="6" style="text-align: center; color: #8fa0b2;">
                데이터를 로드하려면 '새로고침' 버튼을 클릭하세요
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- 로그 -->
    <div class="config-section">
      <div class="section-title">
        📝 시스템 로그
      </div>
      
      <div class="form-group">
        <button class="btn" onclick="clearLogs()">로그 지우기</button>
        <button class="btn" onclick="exportLogs()">로그 내보내기</button>
      </div>
      
      <div id="logs" class="log-container">
        <div class="log-entry">
          <span class="log-timestamp">[2024-01-01 00:00:00]</span>
          <span class="log-level-info">[INFO]</span>
          시스템이 초기화되었습니다.
        </div>
      </div>
    </div>
  </div>

  <!-- Google Sheets API 로드 -->
  <script src="https://apis.google.com/js/api.js"></script>
  
  <script>
    // 전역 변수
    let isApiLoaded = false;
    let isConnected = false;
    let syncInterval = null;
    let dataQueue = [];
    let syncStats = {
      success: 0,
      failed: 0,
      totalRows: 0
    };
    
    // API 설정
    let apiConfig = {
      apiKey: '',
      spreadsheetId: '',
      sheetName: '데이터',
      columnMapping: {
        timestamp: 'A',
        temperature: 'B',
        humidity: 'C',
        energy: 'D',
        door_events: 'E',
        illumination: 'F'
      }
    };
    
    // Google API 초기화
    function initGoogleAPI() {
      return new Promise((resolve, reject) => {
        if (typeof gapi === 'undefined') {
          addLog('error', 'Google API 라이브러리를 로드할 수 없습니다.');
          reject(new Error('Google API not loaded'));
          return;
        }
        
        gapi.load('client', () => {
          gapi.client.init({
            apiKey: apiConfig.apiKey,
            discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
          }).then(() => {
            isApiLoaded = true;
            addLog('success', 'Google Sheets API가 초기화되었습니다.');
            resolve();
          }).catch(error => {
            addLog('error', 'API 초기화 실패: ' + error.message);
            reject(error);
          });
        });
      });
    }
    
    // 연결 테스트
    async function testConnection() {
      try {
        loadConfig();
        
        if (!apiConfig.apiKey || !apiConfig.spreadsheetId) {
          throw new Error('API 키와 스프레드시트 ID를 입력해주세요.');
        }
        
        addLog('info', '연결 테스트를 시작합니다...');
        
        if (!isApiLoaded) {
          await initGoogleAPI();
        }
        
        // 스프레드시트 메타데이터 가져오기
        const response = await gapi.client.sheets.spreadsheets.get({
          spreadsheetId: apiConfig.spreadsheetId
        });
        
        if (response.status === 200) {
          isConnected = true;
          updateConnectionStatus(true);
          addLog('success', `연결 성공: ${response.result.properties.title}`);
          
          // 시트 존재 확인
          const sheets = response.result.sheets;
          const targetSheet = sheets.find(sheet => sheet.properties.title === apiConfig.sheetName);
          
          if (targetSheet) {
            addLog('success', `대상 시트 '${apiConfig.sheetName}' 확인됨`);
          } else {
            addLog('warning', `시트 '${apiConfig.sheetName}'을 찾을 수 없습니다. 사용 가능한 시트: ${sheets.map(s => s.properties.title).join(', ')}`);
          }
          
        } else {
          throw new Error('스프레드시트에 접근할 수 없습니다.');
        }
        
      } catch (error) {
        isConnected = false;
        updateConnectionStatus(false);
        addLog('error', '연결 실패: ' + error.message);
        
        if (error.message.includes('403')) {
          addLog('error', 'API 키 권한을 확인해주세요. Google Sheets API가 활성화되어 있는지 확인하세요.');
        } else if (error.message.includes('404')) {
          addLog('error', '스프레드시트를 찾을 수 없습니다. ID를 확인해주세요.');
        }
      }
    }
    
    // 설정 저장
    function saveConfig() {
      try {
        loadConfig();
        localStorage.setItem('googleSheetsConfig', JSON.stringify(apiConfig));
        addLog('success', '설정이 저장되었습니다.');
      } catch (error) {
        addLog('error', '설정 저장 실패: ' + error.message);
      }
    }
    
    // 설정 로드
    function loadConfig() {
      try {
        apiConfig.apiKey = document.getElementById('api-key').value;
        apiConfig.spreadsheetId = document.getElementById('spreadsheet-id').value;
        apiConfig.sheetName = document.getElementById('sheet-name').value;
        
        const mappingText = document.getElementById('column-mapping').value;
        apiConfig.columnMapping = JSON.parse(mappingText);
        
        // 저장된 설정 불러오기
        const saved = localStorage.getItem('googleSheetsConfig');
        if (saved) {
          const savedConfig = JSON.parse(saved);
          if (!apiConfig.apiKey) {
            document.getElementById('api-key').value = savedConfig.apiKey || '';
            apiConfig.apiKey = savedConfig.apiKey || '';
          }
          if (!apiConfig.spreadsheetId) {
            document.getElementById('spreadsheet-id').value = savedConfig.spreadsheetId || '';
            apiConfig.spreadsheetId = savedConfig.spreadsheetId || '';
          }
        }
        
      } catch (error) {
        addLog('error', '설정 로드 실패: ' + error.message);
      }
    }
    
    // 매핑 검증
    function validateMapping() {
      try {
        const mappingText = document.getElementById('column-mapping').value;
        const mapping = JSON.parse(mappingText);
        
        const requiredFields = ['timestamp', 'temperature', 'humidity', 'energy', 'door_events', 'illumination'];
        const missingFields = requiredFields.filter(field => !mapping[field]);
        
        if (missingFields.length > 0) {
          throw new Error(`필수 필드가 누락되었습니다: ${missingFields.join(', ')}`);
        }
        
        addLog('success', '매핑 검증 완료. 모든 필드가 올바르게 매핑되었습니다.');
      } catch (error) {
        addLog('error', '매핑 검증 실패: ' + error.message);
      }
    }
    
    // 헤더 생성
    async function createHeaders() {
      try {
        if (!isConnected) {
          throw new Error('먼저 Google Sheets에 연결해주세요.');
        }
        
        loadConfig();
        
        const headers = [
          ['타임스탬프', '온도(°C)', '습도(%)', '에너지(kWh)', '문 이벤트', '조도(lux)']
        ];
        
        const range = `${apiConfig.sheetName}!A1:F1`;
        
        const response = await gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId: apiConfig.spreadsheetId,
          range: range,
          valueInputOption: 'RAW',
          resource: {
            values: headers
          }
        });
        
        if (response.status === 200) {
          addLog('success', '헤더가 성공적으로 생성되었습니다.');
        }
        
      } catch (error) {
        addLog('error', '헤더 생성 실패: ' + error.message);
      }
    }
    
    // 샘플 데이터 로드
    function loadSampleData() {
      const sampleData = [];
      const now = new Date();
      
      for (let i = 0; i < 10; i++) {
        const timestamp = new Date(now.getTime() - (i * 60 * 60 * 1000));
        sampleData.push({
          timestamp: timestamp.toISOString(),
          temperature: (20 + Math.random() * 10).toFixed(1),
          humidity: Math.floor(40 + Math.random() * 30),
          energy: (100 + Math.random() * 50).toFixed(1),
          door_events: Math.floor(Math.random() * 5),
          illumination: Math.floor(200 + Math.random() * 300)
        });
      }
      
      dataQueue.push(...sampleData);
      updateQueueStatus();
      addLog('info', `${sampleData.length}개의 샘플 데이터가 큐에 추가되었습니다.`);
    }
    
    // 동기화 토글
    function toggleSync() {
      if (syncInterval) {
        stopSync();
      } else {
        startSync();
      }
    }
    
    // 동기화 시작
    function startSync() {
      if (!isConnected) {
        addLog('error', '먼저 Google Sheets에 연결해주세요.');
        return;
      }
      
      const interval = parseInt(document.getElementById('sync-interval').value) * 1000;
      
      syncInterval = setInterval(syncData, interval);
      document.getElementById('sync-btn').textContent = '동기화 중지';
      document.getElementById('sync-btn').className = 'btn danger';
      
      updateSyncStatus(true);
      addLog('success', `동기화가 시작되었습니다. (간격: ${interval/1000}초)`);
    }
    
    // 동기화 중지
    function stopSync() {
      if (syncInterval) {
        clearInterval(syncInterval);
        syncInterval = null;
      }
      
      document.getElementById('sync-btn').textContent = '동기화 시작';
      document.getElementById('sync-btn').className = 'btn';
      
      updateSyncStatus(false);
      addLog('info', '동기화가 중지되었습니다.');
    }
    
    // 데이터 동기화
    async function syncData() {
      if (dataQueue.length === 0) {
        return;
      }
      
      try {
        const batchSize = parseInt(document.getElementById('batch-size').value);
        const batch = dataQueue.splice(0, batchSize);
        
        const values = batch.map(item => [
          item.timestamp,
          item.temperature,
          item.humidity,
          item.energy,
          item.door_events,
          item.illumination
        ]);
        
        // 다음 빈 행 찾기
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: apiConfig.spreadsheetId,
          range: `${apiConfig.sheetName}!A:A`
        });
        
        const nextRow = (response.result.values?.length || 0) + 1;
        const range = `${apiConfig.sheetName}!A${nextRow}:F${nextRow + values.length - 1}`;
        
        await gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId: apiConfig.spreadsheetId,
          range: range,
          valueInputOption: 'RAW',
          resource: { values: values }
        });
        
        syncStats.success += batch.length;
        syncStats.totalRows += batch.length;
        updateSyncStats();
        updateQueueStatus();
        
        document.getElementById('last-sync').textContent = new Date().toLocaleString('ko-KR');
        addLog('success', `${batch.length}개 행이 동기화되었습니다.`);
        
      } catch (error) {
        syncStats.failed += 1;
        updateSyncStats();
        addLog('error', '동기화 실패: ' + error.message);
      }
    }
    
    // 데이터 미리보기 새로고침
    async function refreshPreview() {
      try {
        if (!isConnected) {
          throw new Error('먼저 Google Sheets에 연결해주세요.');
        }
        
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: apiConfig.spreadsheetId,
          range: `${apiConfig.sheetName}!A2:F21`  // 최근 20행
        });
        
        const tbody = document.getElementById('data-tbody');
        tbody.innerHTML = '';
        
        if (response.result.values && response.result.values.length > 0) {
          response.result.values.reverse().forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${row[0] || ''}</td>
              <td>${row[1] || ''}</td>
              <td>${row[2] || ''}</td>
              <td>${row[3] || ''}</td>
              <td>${row[4] || ''}</td>
              <td>${row[5] || ''}</td>
            `;
            tbody.appendChild(tr);
          });
        } else {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #8fa0b2;">데이터가 없습니다</td></tr>';
        }
        
        addLog('success', '데이터 미리보기가 새로고침되었습니다.');
        
      } catch (error) {
        addLog('error', '데이터 로드 실패: ' + error.message);
      }
    }
    
    // 샘플 행 추가
    function addSampleRow() {
      const now = new Date();
      const sampleRow = {
        timestamp: now.toISOString(),
        temperature: (20 + Math.random() * 10).toFixed(1),
        humidity: Math.floor(40 + Math.random() * 30),
        energy: (100 + Math.random() * 50).toFixed(1),
        door_events: Math.floor(Math.random() * 3),
        illumination: Math.floor(200 + Math.random() * 300)
      };
      
      dataQueue.push(sampleRow);
      updateQueueStatus();
      addLog('info', '샘플 행이 큐에 추가되었습니다.');
    }
    
    // 큐 비우기
    function clearQueue() {
      dataQueue = [];
      updateQueueStatus();
      addLog('info', '데이터 큐가 비워졌습니다.');
    }
    
    // 모든 데이터 삭제
    async function clearAllData() {
      if (!confirm('정말로 모든 데이터를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
        return;
      }
      
      try {
        if (!isConnected) {
          throw new Error('먼저 Google Sheets에 연결해주세요.');
        }
        
        // 헤더 제외한 모든 데이터 삭제
        await gapi.client.sheets.spreadsheets.values.clear({
          spreadsheetId: apiConfig.spreadsheetId,
          range: `${apiConfig.sheetName}!A2:F`
        });
        
        syncStats = { success: 0, failed: 0, totalRows: 0 };
        updateSyncStats();
        refreshPreview();
        
        addLog('warning', '모든 데이터가 삭제되었습니다.');
        
      } catch (error) {
        addLog('error', '데이터 삭제 실패: ' + error.message);
      }
    }
    
    // 데이터 내보내기
    async function exportData() {
      try {
        if (!isConnected) {
          throw new Error('먼저 Google Sheets에 연결해주세요.');
        }
        
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: apiConfig.spreadsheetId,
          range: `${apiConfig.sheetName}!A1:F`
        });
        
        if (response.result.values) {
          const csv = response.result.values.map(row => row.join(',')).join('\n');
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          link.setAttribute('download', `digital_twin_data_${new Date().toISOString().split('T')[0]}.csv`);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          addLog('success', 'CSV 파일로 내보내기 완료');
        }
        
      } catch (error) {
        addLog('error', '내보내기 실패: ' + error.message);
      }
    }
    
    // 상태 업데이트 함수들
    function updateConnectionStatus(connected) {
      const status = document.getElementById('connection-status');
      if (connected) {
        status.innerHTML = '<span class="status-indicator status-connected"></span>연결됨';
      } else {
        status.innerHTML = '<span class="status-indicator status-disconnected"></span>연결되지 않음';
      }
    }
    
    function updateSyncStatus(syncing) {
      const status = document.getElementById('sync-status');
      if (syncing) {
        status.innerHTML = `<span class="status-indicator status-connected"></span>동기화 중 (대기 중: <span id="queue-count">${dataQueue.length}</span>개)`;
      } else {
        status.innerHTML = `<span class="status-indicator status-disconnected"></span>중지됨 (대기 중: <span id="queue-count">${dataQueue.length}</span>개)`;
      }
    }
    
    function updateQueueStatus() {
      const queueCount = document.getElementById('queue-count');
      if (queueCount) {
        queueCount.textContent = dataQueue.length;
      }
    }
    
    function updateSyncStats() {
      document.getElementById('sync-success').textContent = syncStats.success;
      document.getElementById('sync-failed').textContent = syncStats.failed;
      document.getElementById('total-rows').textContent = syncStats.totalRows;
    }
    
    // 로그 관련 함수들
    function addLog(level, message) {
      const logs = document.getElementById('logs');
      const logEntry = document.createElement('div');
      logEntry.className = 'log-entry';
      
      const timestamp = new Date().toLocaleString('ko-KR');
      logEntry.innerHTML = `
        <span class="log-timestamp">[${timestamp}]</span>
        <span class="log-level-${level}">[${level.toUpperCase()}]</span>
        ${message}
      `;
      
      logs.insertBefore(logEntry, logs.firstChild);
      
      // 로그가 너무 많으면 오래된 것부터 삭제
      if (logs.children.length > 100) {
        logs.removeChild(logs.lastChild);
      }
      
      // 로그 컨테이너를 맨 위로 스크롤
      logs.scrollTop = 0;
    }
    
    function clearLogs() {
      document.getElementById('logs').innerHTML = '';
      addLog('info', '로그가 지워졌습니다.');
    }
    
    function exportLogs() {
      const logs = document.getElementById('logs');
      const logText = Array.from(logs.children).map(entry => entry.textContent).join('\n');
      
      const blob = new Blob([logText], { type: 'text/plain;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `digital_twin_logs_${new Date().toISOString().split('T')[0]}.txt`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      addLog('success', '로그가 텍스트 파일로 내보내졌습니다.');
    }
    
    // 외부에서 호출할 수 있는 함수들 (메인 대시보드에서 사용)
    window.GoogleSheetsAPI = {
      addData: function(data) {
        dataQueue.push(data);
        updateQueueStatus();
      },
      
      isConnected: function() {
        return isConnected;
      },
      
      getStats: function() {
        return syncStats;
      }
    };
    
    // 초기화
    window.addEventListener('load', () => {
      loadConfig();
      updateQueueStatus();
      addLog('info', 'Google Sheets API 통합 페이지가 로드되었습니다.');
      
      // 자동으로 저장된 설정이 있으면 연결 테스트
      if (apiConfig.apiKey && apiConfig.spreadsheetId) {
        setTimeout(testConnection, 1000);
      }
    });
  </script>
</body>
</html>